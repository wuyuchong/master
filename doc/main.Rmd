---
title: "基于数据挖掘算法的企业财务指标对未来成长性的预测研究"
output:
  word_document:
    toc: yes
    toc_depth: 2
    fig_caption: yes
    reference_docx: template.docx
csl: chinese-gb7714-2005-numeric.csl
bibliography: reference.bib
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE)
# base_family = 'STXihei'
library(rmarkdown)
library(knitr)
library(tidyverse)
library(scales)
library(magrittr)
dat = read.csv('../data/data_for_model.csv', header = TRUE)
code_name = read.csv('../data/code_name.csv')
dictionary = read.csv('dictionary.csv')
percent_round = function(x){
  scales::percent(x, accuracy = 1L)
}
N = length(unique(code_name$industry))
industry_table = code_name %>% 
  count(industry) %>%
  filter(industry != '') %>% 
  mutate(percent = percent(n / nrow(code_name))) %>%
  arrange(desc(percent))
unique(dat$fin_year)
# processed = mutate(dat, diffRevenue = ifelse(diffRevenue > 0, 1, 0))
# processed = filter(processed, fin_year == 2019)
# table(processed$diffRevenue)
# processed = dat[!is.na(dat$roeAvg) & !is.na(dat$diffPNI), ]
```

\newpage

# 内容摘要{-}

> 缺少集成学习

本研究以A股全体上市公司为主体，使用年报公开披露的财务指标，对企业未来的成长性展开预测研究。使用主营业务收入涨跌和归属母公司净利润增长率衡量企业成长性，使用 T 年的财务指标预测 T+1 年的成长性。

影响企业成长性的因素非常多，我们的研究重点在于企业的财务指标，不关注市场形势和宏观经济，因此在预测时我们并不追求预测结果完全准确，而是更多地关注预测未来成长性高的企业与同行业企业的比较，即通过对历史成长性高的企业财务指标共性特征的学习，找到一个未来成长性高的公司组合，这个组合将“跑赢”同行业的其它企业。

使用缺失值填补、高稀疏性分类变量聚类处理、异常值处理、标准化处理、特征变换、SMOTE 过采样处理等预处理和特征工程方法，经过的交叉验证对三种基本模型进行处理前后效果比较，我们选择最合适的处理方式，很大程度上提高了最终模型的效果。

借助阿里云服务器，使用各种线性、非线性、基于树与规则的模型进行训练、调参和模型校准，经过交叉验证比较，梯度下降树这类模型在企业未来成长性问题上表现较好，效果最好的为 CatBoost 模型，在测试集2021年营业收入涨跌二分类预测上达到了 0.71 的 AUC (召回率 85%，精准度 66%)，相比随机猜测提高 21 个百分点；归母净利润增长率预测上 $R^2$ 达到 0.26。由于营业收入和净利润受到宏观经济、市场需求等众多因素的影响，并不仅仅由企业的财务状况决定，因此该预测模型的效果已经具备很强的现实意义。

使用2020年的财务指标预测2021年的主营业务收入涨跌和归母净利润增长率。各行业模型预测主营业务收入增长的企业实际平均增长率为36%，即使2021年宏观经济形势较好，同行业上市公司平均增长率也仅有23%，除了家用电器行业外，其它27个全部高于同行业其它公司。 各行业预测净利润涨幅前5的企业实际平均增长率为67%，前10的企业为61%，前20的企业为49%，前30的企业为44%，同行业均值仅为18%，预测成长性强的企业实际表现远超同行业企业。同时，我们给出2022年（目前尚未披露年报）各行业成长性最高和最低的企业预测。

经过模型学习，对企业未来主营业务收入结果影响最大的财务指标排序为权益乘数、资产负债率、市盈率、总资产同比增长率、市净率；对未来归母净利润增长率结果影响最大的指标为净资产收益率、市净率、市盈率、每股收益、经营性现金净流量与净利润之比。我们使用 shap 值分析财务指标对模型的影响方式，同时结合财务指标的实际含义和金融市场的基本面分析，分析财务指标对企业未来成长性的影响逻辑。为了解释模型预测企业未来成长性的逻辑，我们选取贵州茅台和包钢股份两家较典型具备代表性的公司进行预测路径的分析，进一步深入探讨企业的各项财务指标如何影响成长性的预测。

本研究为研究人员提供企业未来成长性预测方法的借鉴，同时通过数据挖掘模型从历史数据中学习的规律，为金融相关从业人员提供解读各项财务指标对企业未来成长性影响的新视角。

\

**关键词**： 企业成长性 \ \ \ 财务指标 \ \ \ 数据挖掘算法 \ \ \ 机器学习 \ \ \ SHAP影响解释 \ \ \ 净利润 \ \ \ 主营业务收入

\newpage

# 绪论

## 研究背景

---

作为评估企业竞争力和发展潜力的重要体现，企业的成长性备受市场广大投资者关注。财务指标是衡量企业财务状况和过去经营表现的重要工具，分析财务指标可以帮助评估企业的竞争实力和未来的成长潜力。

随着数据挖掘技术的不断发展，众多机器学习算法已经广泛应用于各种分类和定量预测问题中。数据挖掘技术可以从海量数据中提取有价值的信息和模式，通过数据挖掘技术分析财务指标，可以更加准确地预测企业的未来成长性，为市场上众多的投资者提供参考。

---

投资者常用净利润和主营业务收入的同比增长率衡量企业的成长性，单纯使用净利润或主营业务收入衡量成长性都可能会有失公允：单纯企业净利润上升可能不是由于主营业务的上涨带来的，而是通过减少费用或非经常性收益获得利润增长，不能反应真实的成长性；单纯主营业务收入的上升可能并不能有效转化为净利润的上涨，投资者常用“增收不增利”来形容这种情况，也不能有效反映企业的成长性。因此衡量企业成长性，需要将净利润和主营业务收入两个指标结合起来看。一般来说，投资者对净利润最为看重，因为其关系到每股净收益，影响了公司的分红情况，企业的赢利性对股价的影响很大。投资者对主营业务收入的关注则会稍微低一些，一般情况下仅要求主营业务随净利润有所增长即可。


## 研究思路及方法

我们拟研究财务指标和未来成长性（主营业务收入、归属母公司净利润等）之间的关系，同时依托机器学习算法使用T年的财务指标预测T+1年的营收与利润（包括绝对值与增长率）。我们使用公司的年报财务指标作为自变量，由于数据更新频率低，我们抛弃传统的时间序列处理方法，将 2007 年至 2021 年间 A 股所有上市企业的所有年份经过处理后视为同等的观测，使用（T – 1）年的年报的财务数据（于 T 年披露）和 T 年基准日的估值指标对 T 年的年报的营收和利润的绝对值和增长率（于 T + 1 年披露）进行拟合和预测。样本量约为6万（4000 家 15 年），变量个数约为 50。我们使用缺失值填补、高稀疏性分类变量聚类处理、异常值处理、标准化处理、特征变换、SMOTE 过采样处理等预处理和特征工程方法，使用多种机器学习算法进行预测。

研究过程思路如下：

1. 数据获取及整理：收集企业财务数据，通过A股所有上市公司历史发布的资产负债表、利润表和现金流量表获取财务原始数据，通过进一步计算的方式得出有效的财务指标，同时结合股价计算出估值指标。
1. 数据集划分：
1. 预处理与特征工程：在进行数据挖掘算法训练之前，对数据进行预处理，包括数据清洗、缺失填补、异常处理、特征变换和倾斜修正等，消除数据中的噪声和冗余，提高数据的质量和准确性，以提升模型的预测效果。
1. 模型训练：对于归母净利润增长率，由于它是成长性的核心度量指标，我们直接对其进行定量预测。对于主营业务收入，由于投资者对其关注稍微低一些，一般情况下仅要求主营业务随净利润有所增长即可，因此我们对其进行涨跌二分类预测。我们使用各种经典且具有代表性的线性模型、非线性模型、分类树与基于规则的模型进行调参训练，同时对分类模型使用校准算法对输出的概率值进行校准，并比较各种模型的优劣。之后，我们还使用集成学习（Bagging、Boosting、Blending、Stacking）进行多模型的集成训练。
1. 预测效果分析：使用效应集衡量模型的预测结果在实际应用中的效果，使用2020年的财务指标预测2021年的主营业务收入涨跌和归母净利润增长率，观察模型预测结果为高增长的企业组合增长率是否超过同行业其它企业。
1. 模型解释：我们使用 shap 方法计算每个财务指标对模型的贡献，并结合指标在金融方面的实际含义解释其影响预测结果的原因。同时我们也对模型的预测过程进行解释，我们选取成长股贵州茅台和周期股包钢股份这两家被市场上的投资者所熟知的企业作为我们解释模型预测过程的典型例子，展示模型如何通过这两家公司过去的财务指标预测其未来的成长性。
1. 研究结果分析和应用：通过对数据的建模和预测，本研究将得出一些关于财务指标对未来成长性的预测结果。研究者将对结果进行分析和解释，并将研究结果应用到实际的企业决策制定中，为企业提供科学的决策支持。

## 研究内容及框架

拟通过研究企业的财务指标和其未来主营业务收入、归属母公司净利润等成长性相关指标之间的关系，使用机器学习算法对企业未来的成长性进行预测。通过与同行业企业比较的方式验证预测结果的准确性和可应用性，给出成长性较高的企业的财务指标特征，并给出未来各行业成长性最高的企业名单。拟达成的预期效果为：预测营收和利润增长率最高的 TOP 5 / 10 / 20 的企业均值应显著高于同行业均值。同时我们将比较不同的预测模型和算法的优劣。

> 缺少一个流程图

## 研究意义

在对企业进行基本面研究时，业内普遍认为企业的财务指标与其未来的成长性具有关联。投资者们认为未来成长性高的公司多数质地优秀，从公司的财务状况可以一定程度上分析未来的成长性，例如业内普遍认为质地优秀的公司具有较低的存活周转天数、应收账款与预收账款比、负债率等等。然而，当期财务指标与企业未来的成长性关联并不是完全线性的。目前在学界对该方面进行探讨和验证的研究较少，更少有研究通过企业的财务指标对未来成长性进行预测。我们使用主营业务收入、归属母公司净利润等指标来衡量公司未来的成长性，通过企业过去的财务指标表现情况预测其未来的成长性。

提高企业成长性的预测准确度，为研究人员提供企业未来成⻓性预测方法的借鉴：传统的财务分析方法通常依赖于专业分析师的经验和知识，很难进行迭代和优化，无法大规模应用于众多的企业。而利用数据挖掘技术分析财务指标可以充分利用较多的数据量，挖掘出隐藏在数据中的有效信息和潜在联系，提高预测准确度。将数据挖掘技术应用于企业财务指标上，将机器学习算法应用于财务指标对成长性的预测上，拓展了数据挖掘在财务领域的应用深度。

探究财务指标对企业未来成长性的影响作用：传统的机器学习预测算法通常是一个“黑盒”，仅仅给出预测结果而无法得出预测路径，指标的贡献关系不明晰。在本研究中，我们使用 shap 方法对喂入训练的指标进行解释，通过大量数据的训练揭示财务指标对企业未来成长性的影响方式，结合财务指标的实际含义，解释模型中财务指标对企业未来成长性预测的影响机制和作用方式，提炼出未来将高增长的企业共有的特征。

为投资者和企业提供决策依据：通过对上市企业未来成长性的预测，可以为市场上广大投资者的决策提供科学准确的辅助。通过个股预测路径分析，投资者可获知企业各个财务对未来增长可能产生正面或负面影响；通过预测结果排序，投资者可以构建一个未来增长率超出同行业企业的公司组合，以获取相对大盘的超额收益。同时，本研究给出高增长企业财务指标所具备的共同特征的概括，辅助企业作出竞争力和未来盈利能力的战略决策。

## 研究创新

1. 选题自身具有较高创新性，目前与此相近的课题非常少。较多学者研究企业未来的成长性，但主要是通过对核心业务的调研、对运营方式的点评、对所在行业的分析对某个企业或行业内的几家企业进行成长性的评价，很少有研究直接使用企业的财务指标对未来成长性进行预测。领域相关的多数文章集中于财务指标对财务舞弊及风险识别预测、财务指标作为因子的股价量化研究。
1. 全市场多年份大数据视角挖掘企业财务指标与成长性的内在联系并使用多种机器学习算法进行预测。现有研究对企业成长性研究的范围往往局限于公司所处的政策环境制度、盈利能力、营销模式以及企业资源及能力理论，只对企业的外生因素做了相应解释，很少直接使用数据进行对未来的预测，且预测使用的回归模型拟合能力较差，影响成长性的因素很多，使用简单的线性模型无法真正反映企业未来的趋势。因此我们使用目前较为前沿的机器学习技术进行拟合预测，并比较不同的预测模型和算法的优劣。同时，在拟合过程中，我们使用给出各个财务指标的重要性，并针对重要的特征进行分析。
1. 使用逐年后推法替代传统的时间序列方法：与大多数量化研究都使用时间序列研究方法不同，因财务指标数据更新频率为年^[考虑到季报和半年报的局限性，我们仅使用年报作为财务指标的获取来源，见数据处理部分] ，我们并没有使用对单一企业财务数据的时间序列处理方法，将所有企业的所有年份经过处理后视为同等的观测值，使用 T 年的年报数据的财务数据对 (T + 1) 年主营业务收入和归母净利润增长率进行拟合和预测。
1. 预测过程中严格屏蔽处于“未来状态”的信息：在预测过程中，我们采取了两种方法保证“未来”的信息不会泄漏到历史数据中。一是在数据处理时我们严格控制每条样本自变量仅能使用 T 年及之前的财务或股价数据，因变量为 (T + 1) 年主营业务收入和归母净利润增长率，二是预留出了测试集和效应集，这两个数据集为模型训练和验证时从未接触过的年份数据，以测试模型在新年份下的预测效果，避免因市场随时间发生风格变化而导致模型失效的情况。
1. 不追求个体企业预测的准确性，仅评价组合的效果，预测高增长企业“跑赢”同行业企业。由于企业的主营业务收入和归母净利润受影响的因素错综复杂，单纯使用财务指标得到主营业务收入和归母净利润的精确预测值既不合理也不现实，但我们可以根据财务指标对企业成长性的预测值排序来构造企业组合，因此在本研究中也无需将宏观指标加入模型。只要预测营收和利润增长率最高的 TOP 5 / 10 / 20 / 30 的企业均值显著高于同行业均值，模型即具备现实意义。
1. 不仅建立预测模型，同时通过模型对数据挖掘学习的结果，分析财务指标对模型的影响方式，同时结合财务指标的实际含义和金融市场的基本面分析，分析财务指标对企业未来成长性的影响逻辑。为了解释模型预测企业未来成长性的逻辑，我们选取贵州茅台和包钢股份两家具备代表性的公司进行预测路径的分析，进一步深入探讨企业的各项财务指标如何影响成长性的预测。

# 文献综述

## 企业成长性的影响因素

在国外学者的研究中，Honig（1998）证明了企业的关键决策对其成长影响显著。@1998What
Krugman（1991）发现地理位置也是重要影响因素之一，公司的货运成本、产业资源、客群因地理位置而不同，对其成长性具有影响。@1993Geography
> 此外，Brealey（2000）还指出企业融资情况影响经营决策进而对企业成长性产生影响，当企业自身债务水平较低且处于融资能力较强时，往往具备较高的成长性。

Garnsey和Heffernan（2006）等人认为企业的成长性与公司的战略选择有关。他们将公司成长划分为持续成长和保守经营两种状态。管理层会对公司未来的成长前景进行评估，当公司面对挑战或机遇时，管理层会权衡公司未来是否应继续保持扩张态势。在激烈的市场竞争中，如果公司无法提高自身市场地位，那么公司可能会处于努力维持经营现状的状态，此时企业收缩新业务并尽可能增加现金储备，由持续成长转入保守经营。@2006New

国内学者张炳坤（1998）认为企业成长性的影响因素既有内部财务状况、管理层决策等内部因素也有市场环境、供需关系等外部因素。@z1998 
谢文君（2016）则发现企业的财务结构会影响企业的融资难易度，从而影响其成长性。@x2016
> 官金华、常有新（2005）则通过因子分析法对企业成长性因素进行了分类，通过多元回归分析等统计学方法证明了企业运营能力对其成长性有统计学上显著的影响。

## 企业成长性的衡量指标

Delmar（1997）统计汇总了当时近八年的文献，使用企业的营业收入作为企业成长性的衡量指标的文献数量最多，另有部分文献使用含营业收入在内的多种混合指标衡量企业成长性。@1997High
> Leona（2010）发现过去12年的文献中，四成文献使用营业收入作为衡量企业成长的指标。

也有部分学者仅使用单一的指标进行衡量，

官金华和常有新（2015）使用综合评价方法，同时使用财务指标（营业收入增长率）和非财务指标两个方面评价创业板公司的成长性。@g2015

张超和孙英隽（2018）使用主营业务收入增长率、期间费用率、总资产增长率和净资产收益率增长率四者的加权平均数代表上市公司的成长性。
通过多元回归的方式证明了财务指标中的资产负债率、销售净利率增长率、总资产周转率增长率与公司的成长性强相关。@z2018

## 企业成长性的预测指标

魏文兰（2014）建立了一个包括盈利能力、偿债能力、营运能力和现金流量等多种指标的财务评价体系以评估企业的成长性。@w2014
部分国内学者使用多指标组合衡量企业成长性，朱和平（2004）选取了20个指标，从公司的财务状况、资本与员工质量、市场营销能力和创新能力四个方面衡量企业成长性。@z2004
国外的研究者们用各种不同指标来度量企业的成长，例如Garnsey（2006）等学者使用包括投资资金、人力等投入指标，股权、资本、资产等价值指标，以及销售额、利润等产出指标。@2006New




---


刘昊（2020）使用长短期记忆人工神经网络，使用财务报表信息对上市公司的盈利进行预测，预测结果在偏差和方差两个维度均优于分析师的预测结果。@2020LSTM

毕娟（2006）运用判别分析和逻辑回归方法，使用 1997 年上市公司的财务指标对 1998 年到 2003 年我国上市公司的成长状况进行预测分析，认为我国上市公司的财务指标所包含的信息含量能够用来预测公司未来的发展状况。@b2006

Dujak等（2016）提出一个中小型物流公司的增长预测模型，使用活跃的六万多家物流公司在2010年至2014年期间的资产负债表和利润表中的财务指标，确定了具有高增长潜力的中小型物流服务提供商具有的一些共同特征，并预测这些企业的增长趋势。@2016Predicting

ZekicSusac等（2016）使用收入、资产等财务信息，预测克罗地亚公司未来三年资产年化增长率是否超过 20%，并发现当使用所有可用变量时，神经网络相比逻辑回归的分类准确性显著更高。@Zeki2016Predicting

Rahmanifirouzjae等（2021）提出了一个预测成长股迁移的模型，他们研究了2012年至2019年底在德黑兰证券交易所上市的所有公司，通过样本公司的财务健康状况使用随机森林算法预测成长股向价值股的转变，证明了历史信息可以用于预测公司的成长性。@2021Predicting

Stjepan等（2022）使用财务比率预测企业是否具备较高的成长潜力，通过衡量公司利用资产产生利润的效率，使用EBITDA利润率、债务比率、股本与负债比率、资产回报率等指标，取得了较好的预测效果（AUC = 0.627）。@2022Can

Zhou和Gumbo（2021）利用南非第二大省KwaZulu Natal的191家中小制造业企业三年的面板数据预测未来的成长性，发现销售收入是企业增长的最重要的驱动因素，并比较了传统逻辑回归和两种机器学习技术（人工神经网络和支持向量机），发现SVM和NN的组合在预测企业成长性方面比逻辑回归表现更好。@2021Comparative

Alex等（2014）指出虽然识别出潜在的高成长性企业对调节宏观经济和制定公共政策很重要，但预测哪些企业未来将有较高的成长水平并不容易，企业目前的表现与潜在的成长性之间的关系通常是间接且复杂的。@2014High

Sampagnaro（2013）将意大利制造业 22000 家公司分为高增长和非高增长企业两组，并对两组公司的资产负债表比率指标进行了判别分析，发现公司规模、非金融债务和内部现金流对公司的增长影响最大。同时，利用 T-1 年发布的财务报表预测 T 年的增长。@2013Predicting

---







## 企业成长性的预测

当前，国内外有关企业成长性预测的研究较少，但仍然有一些与此相关的工作，如对于企业收入和现金流进行预测。Nabil等人研究了45家不同行业的沙特公司的当前收益和现金流以及收益分解来预测未来经营现金流的能力。此外，Hu等人利用历史的会计收益和现金流信息，使用时间及空间序列技术来预测未来的资本现金流走向。在该项工作中，Hu等人利用胡志明市242家非金融行业上市公司的数据，预测了未来的现金流。

国内也有许多研究者对企业的盈利及现金流等指标进行了预测。王丹萌等人从两方面对企业的盈利数据进行了预测，一是利用与Huu等人类似的时间序列分析技术根据2000余家餐饮类企业一年的盈利数据提出了基于LSTM神经网络作为盈利预测模型：另一个方法则是根据线上点评网站上用户的评价信息对商家的盈利能力进行预测。平安琪等人从“语言学”的角度出发，根据上市企业年报中管理层讨论和分析本年度经营情况时的语调对企业的盈利能力进行预测。林莉（2009）等人使用近三年销售收入增长率、净利润增长率、雇员增长率等指标，利用主成分分析法（PCA）对公司未来成长性进行预测，为企业发展提高参考，但此方法假设没有信息损失，前提条件较为严格。张玉明（2011）等人使用BP神经网络方法对企业成长性进行预测，输入指标考虑了企业的盈利能力、成长潜力、生存状态等方面，将30家公司的数据作为训练集，将评估结果与专家分析结果对比，表明两者间误差较小。林榅荷（2016）使用了灰色理论方法对文化企业的成长性进行预测，利用一阶灰色预测模型对企业3年间的成长数据进行建模及预测，取得了不错的成果，但数据样本量较少，且未考虑定性指标的影响。

## 数据挖掘算法

数据挖掘算法发展历史悠久，算法丰富多样，在此我们仅叙述新兴的以神经网络为代表的机器学习算法。在1943年，Warren McCulloch提出了由输入层、隐藏层、输出层组成的网络结构，这被广泛认为是神经网络的雏形。随后在20世纪六十年代，Frank Rosenblatt给出了感知机的概念，用算法及数学公式定义了神经网络模型，对机器学习产生了较大影响。从20世纪八十年代开始，机器学习理论开始迅速发展。1984年，Hinton和Rumelhart给出BP神经网络的概念，使得感知机逐渐回到了人们的视线中。在1989年，卷积神经网络由美国学者LeCun以及Yann提出，并给出了基于反向传播的训练方式，在英文识别方向取得了较好的效果。在1995年，支持向量机SVM和Adaboost算法分别被Vapnik以及Freund等人提出，代表着核技术以及集成学习算法开始逐渐崭露头角。而在二十一世纪初，由Breiman等人提出随机森林算法，因其能够并行计算且具有抗拟合能力至今仍在机器学习领域被大量使用。在2006年，Hinton和Salakhutdinov提出深度学习Deep Learning模型，引入了多隐藏层的结构，成为深度学习领域的里程碑。

各类数据挖掘方法被广泛运用在各种预测问题上，并取得了优秀的效果。国外学者 Fan 等使用支持向量机的分类方法选择出可能有超常表现的个股，得出一个等权重的组合，在五年期获得超过澳大利亚股票市场基准指数 71% 的回报率。Singh 等人展示了深度学习能够提升股票价格预测的准确性，并且实验得到深度神经网络的实际收益与预测收益之间的相关系数比径向基函数神经网络高 17.1％，比递归神经网络高 43.4％。Takeuchi 将深度学习应用到趋势交易策略中，使用了堆叠约束玻耳兹曼机从个股历史价格中提取特征，得到一个增强的动量交易策略，取得了原始趋势基准的成绩。


## 文献述评


# 数据来源和处理方式 

## 数据获取

使用两种主流的股票数据库 akshare ^[https://www.akshare.xyz] 和 baostock ^[http://baostock.com] 逐一获取 A 股所有股票 2007-2022 年的估值指标数据、已发布的财报财务指标数据，原始数据获取共 1.1 GB，之后进行合并计算处理等整理工作。 ^[指标计算方式详见附录]

由于剔除已退市企业会造成“来自未来信息的泄漏”，为避免该逆向筛选的发生，我们仍然将已知退市的股票的历史信息纳入了我们后续的分析和模型中。

我们共获取4892家上市公司的数据，涵盖了29个申万一级行业分类，其中机械设备、化工、医药生物和电子行业的占比最多。 ^[每个申万行业个股数量及占比见附录]

```{r}
dictionary %>% 
  select(指标类型, 指标, 指标名称) %>% 
  kable(caption = '指标一览')
```

## 数据处理

A股所有上市企业每年发布四份本公司的财务报表，分别为年报、半年报、一季报和三季报。与年报不同，季报和半年报无需被审计，因此许多公司在编制一季报、半年报和三季报时严谨性较差；而年报的编制则较为详实，可信度较高，且进行了更加仔细频繁的校验和调整。

季报和中报的可操纵空间较大，部分公司存在先发布业绩预报，利用季报和中报做数据调整，以此实现业绩超预期来进行股价炒作的现象。然而，对于年报，这种做法则较少，一方面是因为年报受到审计的限制，调整余地小，另一方面是伪造年报的法律风险较大。同时，季报和中报受到季节周期的影响较大，大部分企业的营收等指标在一年中不同季度的分布经常是不均匀的，且在不同行业间差异较大。

因此，我们仅使用年报披露的财务数据作为研究对象。所有的企业都在每年的 1-4 月份披露前一年的年报，因此在每年的 5 月份的首个交易日所有企业上一年的年报均已披露。由于估值指标会收到股价的影响，因此我们统一将每年 5 月的首个交易日作为基准日，使用该日的估值指标（PE、PS、PB），此日至下一年 5 月的首个交易日作为一个年周期。

将 2007 年至 2021 年间 A 股所有上市企业的所有年份经过处理后视为同等的观测，使用（T – 1）年的年报的财务数据（于 T 年披露）和 T 年基准日的估值指标对 T 年的年报的营收和利润的绝对值和增长率（于 T + 1 年披露）进行拟合和预测。样本量约为6万（4000 家 15 年），变量个数约为 50。

> 缺少数据处理示意图

## 数据集划分及抽样方式

```{r}
table = read.csv('dataset_describe.csv')
kable(table, caption = '数据集划分方式')
```

我们将整个数据集划分为 6 个集，以保证训练后的模型在面对未知的新样本时具备较强的泛化能力和性能，尽量避免出现过拟合和欠拟合的情况。

训练集、验证集使用 2007 - 2018 年 ^[此处年份指的是自变量年份] 的财务数据。目的主要为使两个集合的标签分布基本保持一致，以获得效果较好的模型。我们使用十折交叉验证的方式，将 2007 - 2018 年的财务数据随机平均分为十份，在每次训练中，90%作为训练集，10%作为验证集。我们使用训练集中的数据进行训练，在验证集上进行预测，得出验证集上的评价指标。由于模型在学习时无法接触到验证集的样本，验证集上的评价指标可以作为模型是否过度拟合训练数据的依据。因此，我们使用验证集上的损失指标调整模型模型结构、学习率、正则化系数等超参数。

测试集使用是训练过程中从未直接或间接接触的数据，待模型参数调整完毕后，使用测试集来评价模型的最终效果。我们使用 2019 年的财务数据和 2020 年的主营业务收入、归母净利润增长率作为测试集，作用在于评判依靠“过去”的数据建立的模型在“未来”的数据集上的拟合效果，测试集中的数据已经超出了训练集所能接触到的年份，因此可以评价模型是否拥有足够强的泛化能力。

效应集用来评价模型解决研究问题的实际能力，使用 2020 年的财务数据和 2021 年的主营业务收入、归母净利润增长率，我们对模型预测出的各行业主营业务收入和利润增长率最高的 TOP 10 / 20 / 30 的企业均值与同行业均值进行比较，以得到在真实情况下模型的效果。

预测集使用 2021 年财务指标（财报于 2022 年披露），对2022年企业成长性（目前尚未披露2022年年报）进行预测。

# 预测模型搭建

## 评价指标

在所有环节中，我们使用十折交叉验证取平均的方式对各种模型和方法进行评估。

### 主营业务收入涨跌二分类预测

在主营业务收入涨跌二分类预测问题中，由于多数企业的主营业务收入多数年份上升，上升的样本明显多余下降的样本，存在不平衡的情况，因此准确率（Accuracy）、精确率（Precision）、召回率（recall）仅作为观测指标，不作为各模型和方法的评价指标，为衡量不平衡样本下各模型的表现情况，我们使用精确率和召回率的加权调和平均 F1 值来评价模型。

$$ F 1=\frac{2}{\frac{1}{\text { Precision }}+\frac{1}{\text { Recall }}} $$

同时，使用 ROC 曲线与 X 轴围成的面积除以总面积得到的 AUC 值作为另一个重要的评判指标。

$$ P(f(p)>f(n))=\frac{\Sigma_{p, n}(i f(f(p)>f(n))}{\Sigma_{p, n}} $$

另一个评判指标为 Matthews 相关性系数（MCC），它度量真实值和预测值之间的相关性，取值在 -1 到 1 之间，值为 0 时代表这是个随机分类器。

$$ M C C=\frac{T P \times T N-F P \times F N}{\sqrt{(T P+F P)(T P+F N)(T N+F P)(T N+F N)}} $$

Kappa 统计量（Cohen 1960） @Cohen1960A 最初用来评估两个评价者结果的一致性，它考虑到了由偶然情况引起的准确性误差。

$$\mathrm{Kappa}=\frac{O-E}{1-E}$$

其中：

* 0 代表预测值与实际值不同，1 代表相同。
* E 代表根据混淆矩阵边缘计数得出的期望准确性
* Kappa 取值范围为：[-1, 1]
* Kappa 值 0.30 到 0.50 之间代表合理的一致性（Agresti 2002） 

### 归母净利润增长率预测

在归母净利润增长率预测是一个回归问题，与二分类的评价指标有所不同。首先我们使用最基本的均方误差计算了测试集上累积误差平方的平均。

$$ MSE_{\text {test}}= \frac{1}{m} \sum_{i=1}^m\left(y_{\text {test }}^{(i)}-\hat{y}_{\text {test }}^{(i)}\right)^2 $$

由于均方误差可能导致量纲问题，对其进行开方得到均方根误差：

$$ RMSE_{\text {test}}= \sqrt{\frac{1}{m} \sum_{i=1}^m\left(y_{\text {test }}^{(i)}-\hat{y}_{\text {test }}^{(i)}\right)^2}=\sqrt{M S E_{\text {test}}} $$

由于均方根误差先对误差进行平方的累加后再开方，放大了较大误差之间的差距，因此我们还使用平均绝对误差进行模型的评估：

$$ MAE_{\text {test}}= \frac{1}{m} \sum_{i=1}^m\left|y_{\text {test }}^{(i)}-\hat{y}_{\text {test }}^{(i)}\right| $$

同时，RMSE适用于预测分布较为平均的预测值。当预测值范围很大时，RMSE容易受到较大值主导。此时即使较小值预测准确，错误预测较大值时，RMSE容易虚高。 相应地，存在较差算法对较大值预测准确，但是较小值偏差严重时，RMSE很可能会被低估。为了解决这个问题，可以先取对数后再求RMSE，即为均方根对数误差。

$$RMSLE_{\text {test}}=\sqrt{\frac{1}{m} \sum_{i=0}^{m-1}\left(\log _e\left(1+y_i\right)-\log _e\left(1+\hat{y}_i\right)\right)^2}$$

平均绝对百分比误差（MAPE）对相对误差较为敏感，不易受到目标变量全局缩放的影响。

$$MAPE_{\text {test}}=\frac{1}{m} \sum_{i=0}^{m-1} \frac{\left|y_i-\hat{y}_i\right|}{\max \left(\epsilon,\left|y_i\right|\right)}$$

上述的衡量方法都不存在上下限，我们引入 $R^2$ 对模型进行评价，其上限为1，越接近1代表模型越好，0.5附近则代表模型效果基本等同于随机猜测。

$$ R^2=1-\frac{S S_{\text {residual }}}{S S_{\text {total }}} \quad \begin{array}{c}
\text { (Residual Sum of Squares) } \\
\text { (Total Sum of Squares) }
\end{array} = 1-\frac{\sum_i\left(\hat{y}^{(i)}-y^{(i)}\right)^2}{\sum_i\left(\bar{y}-y^{(i)}\right)^2} = 1-\frac{\operatorname{MSE}(\hat{y}, y)}{\operatorname{Var}(y)}$$


## 预处理与特征工程

使用各种预处理方法数据集进行处理，以提升后续机器学习模型的计算速度和准确率，使用交叉验证的方式对处理前后模型的拟合效果进行比较。为了尽可能规避单一模型对某种处理方式偏好带来的偶然性，我们同时使用 线性回归/逻辑回归、ridge 回归、knn 模型 三种模型进行处理前后的效果比较。

### 缺失值填补

经检查，由于年报披露未完全、部分指标无法计算出等原因，存在一些企业的部分财务指标常有缺失的情况，且各公司缺失的指标互不相同。多数机器学习算法要求所有指标的值不应是缺失的，因此我们使用不同的处理方式进行处理。

对于因变量（主营业务及净利润）缺失的样本，我们将其进行直接删除；对于自变量财务指标部分缺失的样本，由于直接删除存在缺失值的样本将导致可用样本量明显减少，数据的样本较为珍贵，我们使用插补的方法对缺失值进行处理。

相比于单变量插补法（univariate imputation）使用缺失值所在变量的其它非缺失值进行插补，多变量插补法（multivariate imputation）使用可用的所有变量进行目标缺失值的估计填补。@2017mice 对每个财务指标，当进行该指标的缺失值填补时，该指标作为因变量，其它的财务指标作为自变量，使用 lightgbm 模型进行拟合后预测出缺失值进行填补。

```{r}
table = read.csv('output/classification/preprocess_imputation.csv')
kable(table, digits = 3, caption = '不同插值方法在主营业务收入二分类预测下的效果比较')
```

```{r}
table = read.csv('output/regression/preprocess_imputation.csv')
kable(table, digits = 3, caption = '不同插值方法在归母净利润定量预测下的效果比较')
```

经验证，在主营业务收入涨跌二分类和归母净利润增长率预测问题上，单变量插补法相比多变量插补法在多数情况下效果差距较小，我们最终采用较为简单的单变量插补法。

### 分类变量处理

我们使用独热编码的方式处理非数值型变量，在我们的数据中，我们将‘申万一级行业分类’处理为哑变量。

对于企业名称这一变量，由于企业数量上千，如果进行独热编码处理将导致变量个数过多，这样处理后数据集的高维稀疏性质将导致许多机器学习模型的速度和准确率受到很大影响。因此我们使用聚类方法先对企业名称进行聚类，之后使用聚类标签代替特征的原始值。

### 异常值处理与标准化

对于财务指标，许多比率型指标由于计算方式的原因容易产生极端值。例如，市盈率的计算方式市值与净利润之比，在净利润处于盈亏平衡线附近时，市盈率绝对值接近0，将导致市盈率极端大或极端小。

标准化能消除不同财务指标方差大小的影响。鉴于财务指标的特殊性，我们不使用常规的标准化方法，而是对每个指标使用该样本数据在同指标中的分位距代替其原值。

```{r, out.width='25%', fig.align='center', fig.cap = "库克距离图"}
knitr::include_graphics("figure/regression/Cooks Distance.png")
```

同时，我们使用库克距离剔除异常值，库克距离兼顾残差大小和杠杆率：

$$D_i=\frac{\left(y_i-\hat{y}_i\right)^2}{(m+1) s^2}\left[\frac{h_i}{\left(1-h_i\right)^2}\right]$$

其中，$\left(y_i-\hat{y}_i\right)^2$ 表示第 $i$ 个样本点的残差，$s$ 表示估计的标准差，$h_i$ 表示第 $i$ 个样本点的杠杆率，$m$ 为变量个数。

当样本点超过 $F_{(m, n-m-1)}$ 分布的中位数时说明该样本点具有较大的影响。

为了减少异常值对模型训练的影响，我们剔除了训练集和验证集中库克距离过大的样本，且为了尽可能地贴近现实，提高模型的通用性，在测试集和效应集上，我们并没有对异常值进行处理。

```{r}
table = read.csv('output/classification/preprocess_normalize.csv')
kable(table, digits = 3, caption = '异常值处理与标准化在主营业务收入二分类预测下的效果比较')
```

分位数标准化对逻辑回归、k近邻算法效果改善明显，各项评价指标都有明显提升。

### 特征变换

特征变换改变了变量的分布使得变换后数据呈现一个合适的正态分布，可以有效解决模型的异方差性问题。对于自变量，我们使用 yeo-johnson 和 quantile 方法进行特征变换，对于 quantile 变换方法，由于它并不是线性的，会改变原有变量间的线性相关性。由于财务指标存在负值，Box-Cox 变换不能符合要求，我们使用幂变换方法 Yeo-Johnson 对自变量进行处理，以减小指标的异方差性，使各项财务指标的概率密度函数的形态逼近正态分布，有利于各项机器学习模型的拟合。

当随机变量为正值：

$$ Y=\left\{\begin{array}{ll}
\log (X+1) & \text { if } \lambda=0, X \geq 0 \\
\frac{(X+1)^\lambda-1}{\lambda} & \text { if } \lambda \neq 0, X \geq 0
\end{array}\right. $$

当随机变量为负值：

$$ Y=\left\{\begin{array}{ll}
-\log (-X+1) & \text { if } \lambda=2, X \leq 0 \\
\frac{-\left[(-X+1)^{(2-\lambda)}-1\right]}{2-\lambda} & \text { if } \lambda \neq 2, X \leq 0
\end{array}\right. $$

其中 $\lambda$ 为变换系数，通过机器学习算法进行学习。


```{r}
table = read.csv('output/classification/preprocess_transformation.csv')
kable(table, digits = 3, caption = '不同特征变换方式在主营业务收入二分类预测下的效果比较')
```

```{r}
table = read.csv('output/regression/preprocess_transformation.csv')
kable(table, digits = 3, caption = '不同特征变换方式在归母净利润增长率预测下的效果比较')
```

分位数特征变换处理方式在主营业务收入二分类预测和归母净利润增长率预测中，都体现出非常明显的优势，在各个模型、各项评价指标上均为最优。

### 数据倾斜修正

对于主营业务收入，上涨的样本占比 42% ，预测目标变量体现出较强的不平衡性，因此我们使用 SMOTE 过采样技术进行数据倾斜的修正。

由于各年份下跌的企业占比较少，部分模型可能无法非常有效地学习到决策边界，我们尝试使用 SMOTE 过采样方法平衡类分布。SMOTE 方法从少数类中随机选择样本，通过最邻近算法找到特征空间中样本周围的 k 个样本（k通常取5），在每两个样本之间随机选择点创建新样本。SMOTE 方法虽然解决了样本的不平衡问题，但如果创建的新样本之间有很强的重叠性时，可能会使产生额外的噪音影响模型的效果。

```{r}
table = read.csv('output/classification/preprocess_imbalance.csv')
kable(table, digits = 2, caption = '不同过采样方法在不同模型下的交叉验证效果比较')
```

## 模型训练

我们使用十折交叉验证的方式进行多个机器学习模型的比较。
^[阿里云服务器 Xeon 8 核 CPU 32G 内存]

我们尝试使用各种类型的分类和回归模型对主营业务收入涨跌和归母净利润增长率进行预测，由于回归和分类模型众多，不可能穷尽所有模型，所以选择各大类模型中最为经典高效的算法进行模型比较。

第一类模型为线性模型，线性模型的优点在于不太会受到无信息变量的干扰。线性回归和逻辑回归（lr）为非常经典的基础算法，它可以作为其它模型效果比较的基线。线性判别分析（lda）也是一种计算速度很快、不需要进行额外调参的算法。为了缓解过拟合问题，我们还使用加入L1正则化后的 lasso回归和加入L2正则化后的岭回归（ridge）。

第二类模型为非线性模型。二次判别分析（qda）相比线性判别分析能够产生非线性边界，支持向量机（svm）的核函数使其具备产生极其灵活决策边界的能力。K近邻算法（KNN）通过距离测度的方法使其不需要进行全局搜索，然而容易陷入过拟合中。朴素贝叶斯（nb）使用贝叶斯法则进行预测，然而其要求变量相互独立的假设过强。

第三类模型为分类树和基于规则的模型。基本的分类树（dt）效果不佳，通过 Bagging 的思想，多个分类树组成的随机森林（rf）常常能达到较好的效果。使用 Boosting 方法，分类树的助推 AdaBoost 使用一系列加权的分类器融合为一个集合，取得了比任何一个个体分类器都要好的效果。梯度助推（gbc）最小化指数损失函数，通过调整树深度和迭代次数来调优，CatBoost、XGBoost、LightGBM 都是梯度助推决策树这一基本算法框架下效果较好的改进实现。

在进行模型调参时，对于使用迭代优化的算法，我们使用 early stop 技术防止过拟合，在多次迭代验证集损失未出现明显下降的情况下，提前终止训练。 

```{r, out.width='25%', fig.align='center', fig.cap = "Catboost 模型深度与准确率曲线"}
knitr::include_graphics("figure/classification/Validation Curve.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "Catboost 模型深度与准确率曲线"}
# knitr::include_graphics("figure/regression/Validation Curve.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "svm 模型决策边界"}
knitr::include_graphics("figure/classification/Decision Boundary.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "主营业务收入二分类预测 Morris 敏感度变量重要性"}
knitr::include_graphics("figure/classification/MSA msa.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "归母净利润定量预测 Morris 敏感度变量重要性"}
knitr::include_graphics("figure/regression/MSA msa.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "主营业务收入二分类预测变量重要性"}
knitr::include_graphics("figure/classification/Feature Importance.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "归母净利润定量预测变量重要性"}
knitr::include_graphics("figure/regression/Feature Importance.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "LightGBM 递归特征选择图"}
knitr::include_graphics("figure/tmp/Feature Selection.png")
```

## 模型校准

对于主营业务收入涨跌二分类问题，我们使用模型校准方法对部分模型的输出概率进行校准。逻辑回归输出天然具有概率性质，例如模型的输出值为0.2表示该预测样本有20%的概率为正样本。但是对于其他许多二分类算法而言（例如支持向量机），模型的输出并不能代表真实概率，需要借助模型校准算法，使其输出与真实分布具有一致性。

我们使用 reliability 曲线评估模型预测概率，根据模型的输出将样本分成10个桶，即预测为0至0.1的样本归为一个桶，预测为0.1至0.2的样本归为一个桶等等，以这10个桶作为横坐标；计算每个桶内的正样本占比作为纵坐标。若reliability曲线靠近对角线则说明模型输出基本代表真实概率。

```{r, out.width='25%', fig.align='center', fig.cap = "校准图（校准前）"}
knitr::include_graphics("figure/classification/Calibration Curve.png")
```

我们使用 Platt 校准算法，利用逻辑回归的输出具有概率的性质，对模型输出值进行校准，将模型输出放入逻辑回归中训练，最后将逻辑回归的结果作为模型 $f\left(\mathbf{x}\right)$ 校准结果。首先获取模型在每个样本上的输出  $f\left(\mathbf{x}_1\right), \cdots, f\left(\mathbf{x}_n\right)$，将这些输出与真实标签构建成新的数据集 $\left(f\left(\mathbf{x}_1\right), y_1\right), \cdots,\left(f\left(\mathbf{x}_n\right), y_n\right)$ ，使用逻辑回归进行训练：

$$P(y=1 \mid f)=\frac{1}{1+\exp (A f+B)}$$

其中 $A,B$ 为训练参数，使用最小化交叉熵损失函数对其进行训练。模型校准结果即为逻辑回归的输出结果，即对于样本 $\mathbf{x}_i$ 而言，模型输出为 $f\left(\mathbf{x}_i\right)$ ，那么在该模型下 $\mathbf{x}_i$ 为正样本的概率为 $P\left(y=1 \mid f\left(\mathbf{x}_i\right)\right)=\frac{1}{1+\exp \left(A f\left(\mathbf{x}_i\right)+B\right)}$ 。

```{r, out.width='25%', fig.align='center', fig.cap = "校准图（校准后）"}
knitr::include_graphics("figure/classification/before/Calibration Curve.png")
```

## 模型效果比较

测试集使用是训练过程中从未直接或间接接触的数据，模型参数调整完毕后，使用测试集来评价模型的最终效果。我们使用 2019 年的财务数据和 2020 年的主营业务收入、归母净利润增长率作为测试集，作用在于评判依靠“过去”的数据建立的模型在“未来”的数据集上的拟合效果，测试集中的数据已经超出了训练集所能接触到的年份，因此可以评价模型是否拥有足够强的泛化能力。

### 主营业务收入涨跌

```{r}
table = read.csv('output/classification/comparison.csv')
table = select(table, -Accuracy)
kable(table, digits = 2, caption = '主营业务收入涨跌二分类预测各模型的交叉验证效果比较')
```

```{r, out.width='25%', fig.align='center', fig.cap = "混淆矩阵"}
knitr::include_graphics("figure/classification/Confusion Matrix.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "分类指标"}
knitr::include_graphics("figure/classification/Class Report.png")
```

经过交叉验证模型比较，主营业务收入涨跌二分类预测中，预测效果最好的为各种助推树模型，其中最好的是 CatBoost，在测试集上达到了 0.71 的AUC (召回率 85%，精准度 66%)，相比随机猜测提高 21 个百分点。

CatBoost 作为一个较晚提出的算法，优势在于能够高效合理地处理类别型特征，此外 CatBoost 还解决了梯度偏差以及预测偏移的问题，从而减少过拟合的发生，进而提高算法的准确性和泛化能力。另一方面，CatBoost 使用排序提升的概念，这是一种置换驱动的方法，在数据子集上训练模型，同时在另一个子集上计算残差，从而防止目标泄漏和过度拟合。

```{r, out.width='25%', fig.align='center', fig.cap = "KS 曲线"}
knitr::include_graphics("figure/classification/KS Statistic Plot.png")
```

$$ks=\max\left\{\left|cum\left(bad\_rate\right)-cum\left(good\_rate\right)\right|\right\}=\max\left\{\left|\left(1-TPR\right)-\left(1-FPR\right)\right|\right\}$$

KS（Kolmogrow-Smirnov）值是好样本与坏样本累计分布之间的差值。上图以模型预测的概率分数为横坐标，以正样本和负样本在该概率分数下的累积比例为纵坐标。按照惯例当KS达到0.5时认为模型具备较强的区分能力，在主营业务收入涨跌二分类预测中，该模型达到 0.596 的KS值。当预测概率的阈值设为 0.62 时，预测正确的样本占所有样本的比例最大。


```{r, out.width='25%', fig.align='center', fig.cap = "Lift 曲线"}
knitr::include_graphics("figure/classification/Lift Chart.png")
```

$$Lift=\frac{\frac{TP}{TP+FP}}{\frac{P}{P+N}}$$

> 对 TP 的解释

Lift 曲线横坐标表示预测概率的排名百分比，纵坐标表示在该排名百分比下，正样本的召回率相对于随机分类器的提升倍数。在主营业务收入涨跌二分类预测中，由于该模型的 Lift 曲线一直大于1，因此说明该模型预测能力优于随机选择，预测增长概率前10%的样本召回率相较于不利用模型时提升了1.75倍。

```{r, out.width='25%', fig.align='center', fig.cap = "Gain 曲线"}
knitr::include_graphics("figure/classification/Gain Chart.png")
```

$$Gain=\frac{TP}{TP+FP}$$

相较 Lift 曲线，Gain 曲线不考虑随机分类器的影响，直接以正样本的召回率为纵坐标。在主营业务收入涨跌二分类预测中，预测增长概率前50%的样本召回率约为0.6，比随机猜测高0.1。

```{r, out.width='25%', fig.align='center', fig.cap = "模型在测试集上的 ROC 曲线"}
knitr::include_graphics("figure/classification/AUC.png")
```

ROC曲线通过设置不同的临界值，来展示分类模型在不同临界值下的表现，横轴为 FPR（假阳率），纵轴为 TPR（真阳率）。可将 TPR 理解为累积正样本率，FPR 理解为累积负样本率。

$$TPR = \frac{TP}{TP + FN}$$

$$FPR = \frac{FP}{FP + TN}$$

ROC 曲线与 FPR 轴围成的面积记作 AUC，在主营业务收入二分类预测中，AUC 达到了 0.71，相较于随机猜测，提升了 0.21。然而，AUC 对 FPR 和 TPR 两种错误的代价同等看待，且无法反应如召回率、精确率等实际业务中关心的指标。

```{r, out.width='25%', fig.align='center', fig.cap = "二分类辨别阈值图"}
knitr::include_graphics("figure/classification/Threshold.png")
```

从阈值图可以看出在分类的阈值超过0.36时，精准度的上升已经很难弥补召回率的下降，此时F1值达到最大。

```{r, out.width='25%', fig.align='center', fig.cap = "精确率和召回率曲线"}
knitr::include_graphics("figure/classification/Precision Recall.png")
```

> 通过调整预测概率的阈值，我们可以选择是否尽可能提高未来增长的企业的识别率，此提升召回率的方式会带来一定的精确率的下降，即误纳入了将未来主营业务下跌的企业。随着阈值的变化，CatBoost 模型的平均精确度为XX，在完全召回的情况下精确度仍然维持在XX。

### 归母净利润增长率

```{r}
table = read.csv('output/regression/comparison.csv')
kable(table, digits = 2, caption = '归母净利润增长率定量预测各模型的交叉验证效果比较')
```

经过交叉验证模型比较，在测试集2021年归母净利润增长率预测与主营业务收入预测相类似，预测效果最好的为各种助推树模型，效果最好的模型仍为 CatBoost，$R^2$ 达到 0.26。

```{r, out.width='25%', fig.align='center', fig.cap = "在测试集上的拟合图"}
knitr::include_graphics("figure/regression/Prediction Error.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "在测试集上的拟合残差图"}
knitr::include_graphics("figure/regression/Residuals.png")
```


## 集成模型

### 单种模型集成

使用 Bagging（bootstrap aggregation）算法对数据集进行等概率采样后，创建 10 个相同类别的模型（Estimators）进行拟合，在预测时通过 10 个模型结果投票得出最终结果，这种方法可以显著减小模型结果的方差。

Boosting 算法相较 Bagging 算法，每一次抽样的样本分布不同，通过创建一系列区分顺序的预测器，排在前面的预测器拟合数据后，给予错误预测的样本更高权重，由后续的预测器修复误差。通过把一系列弱学习器进行串联，组成一个强学习器。

```{r}
table = read.csv('output/classification/ensemble.csv')
kable(table, digits = 3, caption = '对主营业务收入的分类预测单模型集成学习效果比较')
```

使用模型比较排名前三的 CatBoost、Light Gradiant Boosting、Extreme Gradient Boosting 模型分别进行 Bagging 集成算法的搭建，发现三种模型相比原模型在各个评价指标上均有一定的提升。由于排名前三的模型本身便运用了 Boosting 的原理，因此进一步进行 Boosting 后不会有效果的提升。

```{r}
table = read.csv('output/regression/ensemble.csv')
kable(table, digits = 3, caption = '对归母净利润的定量预测单模型集成学习效果比较')
```

在对归母净利润的定量预测中，由于随机森林算法本身并没有使用 Boosting 思想，因此在 Boosting 处理后 $MSE$、$RMSE$ 有所下降，$R^2$ 有所上升。

### 多种模型集成

相较于 Bagging 模型使用多个相同模型拟合不同的采样数据，Blending 使用多个不同的模型拟合相同的全体数据，同样适用投票法得出最终的预测结果。相比 Blending，Stacking 并不直接用简单的投票法决定最终预测结果，还使用一个元模型（在此我们使用 lightGBM）进一步拟合各个模型的预测值。

1. 我们创建多个不同模型，喂入财务指标数据，各自独立训练。
2. 根据每个模型的预测创建新的训练集，训练集的自变量是预测结果，因变量是实际值。
3. 训练一个 lightGBM 模型利用多个预测值生成最终预测值。

```{r}
table = read.csv('output/classification/stack.csv')
kable(table, digits = 3, caption = '对主营业务收入的分类预测多模型集成学习效果比较')
```

使用模型比较排名前三的 CatBoost、Light Gradiant Boosting、Extreme Gradient Boosting 模型分别进行 Blending 和 Stacking 集成算法的搭建，发现三种模型相比原模型在各个评价指标上均有一定的提升。对于分类模型，Blending 有两种方式，一种使用预测概率作为投票法的依据，另一种使用预测的二分类结果作为投票法的依据，实践表明，第一种方式的效果在主营业务收入的预测中效果较好。

```{r}
table = read.csv('output/regression/stack.csv')
kable(table, digits = 3, caption = '对归母净利润的定量预测多模型集成学习效果比较')
```

对于 Stacking 模型，业界常有两种方法：

1. 将原始的训练集先分成两部分，70%的数据作为新的训练集，剩下30%的数据作为测试集，第一层在训练集上训练多个模型，预测测试集上的企业成长性，在第二层里直接用测试集在第一层预测的结果做为新特征继续训练。
1. Restack 方法：使用所有的训练数据对第一层多个模型进行k折交叉验证，每个模型在训练集上都有一个预测值，然后将这些预测值做为新特征对第二层的模型进行训练；

第一种方法由于不需要交叉验证，耗时相较于第二种方法较短，且由于两层模型使用的数据不同，避免了信息泄漏问题；然而，其划分方式决定了可用数据量较小，容易产生过拟合现象，且没有第二种方法稳健。实践表明，在进行主营业务收入和归母净利润的预测中，第一种方法效果好于第二种，可能是第二种方法信息泄漏问题较严重导致其在测试集上表现不佳。

# 预测效果

经过预处理、特征工程、模型调参、模型校准、模型比较、集成模型等步骤，我们使用表现最佳的模型，将测试集的数据也加入模型中重新进行训练，将训练后的模型应用于效应集上，观察模型的实际应用效果。

使用 2020 年的财务数据和 2021 年的主营业务收入、归母净利润增长率，评价模型在新年份进行预测的实际能力。

```{r}
table = read.csv('output/classification/portfolio.csv')
names(table)[1] = '一级行业'
table = mutate_if(table, is.numeric, percent_round)
kable(table, caption = '各行业预测增长的公司组合与同行业所有公司主营业务收入增长率比较')
```

使用2020年的财务指标预测2021年的主营业务收入涨跌和归母净利润增长率。各行业模型预测主营业务收入增长的企业平均增长率为36%，即使2021年宏观经济形势较好，同行业上市公司平均增长率也仅有23%，除了家用电器行业外，其它27个全部高于同行业其它公司。

```{r}
table = read.csv('output/regression/portfolio.csv')
names(table)[1] = '一级行业'
table = mutate_if(table, is.numeric, percent_round)
kable(table, caption = '各行业预测公司组合与同行业所有公司归母净利润增长率比较')
```

我们对模型预测出的各行业利润增长率最高和最低的 TOP 5 / 10 / 20 / 30 的企业均值与同行业均值进行比较，对于绝大多数申万一级行业，预测净利润增长率靠前的公司组合2021年实际利润增长率明显高于同行业公司均值，预测净利润增长率靠前的公司组合2021年实际利润增长率明显低于同行业公司均值。各行业预测净利润涨幅前5的企业实际增长率为67%，前10的企业为61%，前20的企业为49%，前30的企业为44%，同行业均值仅为18%。

> 需要进行顺序调整、合并统计、着色

# 财务指标对预测的影响

## 对财务指标的解释

我们使用 shap 值分析财务指标对模型的影响方式，同时结合财务指标的实际含义和金融市场的基本面分析，分析财务指标对企业未来成长性的影响逻辑。

除了 logistic 回归，大多数的机器学习常被认为是“黑盒模型”，然而由于表现最佳的模型为分类树类型的模型，对于此类模型我们可以使用 shap 值解释模型给出的预测值和企业财务指标的关系。我们将所有的财务指标视为模型的贡献特征，通过计算一个财务指标加入到模型时的边际贡献，取该特征在所有不同特征序列的情况下边际贡献的均值，即为该特征的 SHAP 值。

```{r, out.width='25%', fig.align='center', fig.cap = "主营业务收入涨跌预测变量影响排序"}
knitr::include_graphics("figure/classification/SHAP importance.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "归母净利润增长率预测变量影响排序"}
knitr::include_graphics("figure/regression/SHAP importance.png")
```

### 主营业务收入

```{r, out.width='25%', fig.align='center', fig.cap = "主营业务收入涨跌预测变量影响总结图（红色代表该财务指标值高）"}
knitr::include_graphics("figure/classification/SHAP summary.png")
```

### 归母净利润

```{r, out.width='25%', fig.align='center', fig.cap = "归母净利润增长率预测变量影响总结图（红色代表该财务指标值高）"}
knitr::include_graphics("figure/regression/SHAP summary.png")
```

影响未来归母净利润增长程度最大的指标为净资产收益率，过大的净资产收益率代表企业在现有资产下的盈利能力已经很强，未来增长空间较小。与此逻辑相同的指标还有净利润占比营业总收入，占比越低说明企业虽然营收规模很大，但是由于费用支出高导致净利润暂时较低，未来降本很有可能带来利润增长。市净率和市销率体现投资者所给估值相对目前净资产和销售额的溢价，更高的市净率和市销率代表投资者对企业未来成长性的看好。经营性现金净流量占比净利润高说明企业净利润虚增概率较小，净利润获取来源于其经营能力，而不是非经常性收益等不可持续的方式。毛利率越高代表销售额转化为利润的效率越高，未来销售额的提升很容易反映到利润增长上。毛利率和净利率的差异在于净利扣除了各项费用，过高的净利率通常意味着销售费用占比较低，即利润的获取对销售费用投入的依赖较小，未来很难通过强行增加销售费用的方式提升净利润。高成长性的企业往往具有高毛利率、高销售费用占比、低净利率的特征。

```{r, out.width='25%', fig.align='center', fig.cap = "市盈率对归母净利润增长率预测影响图"}
knitr::include_graphics("figure/regression/SHAP peTTM.png")
```

对市盈率而言，其影响方式与市净率和市销率有所不同，由于企业净利润波动较大，甚至经常在盈亏之间转换，因此市盈率指标的绝对值经常会变得很大。过大的市盈率并不代表投资者对该企业的看好，往往是因企业利润处于盈亏平衡边缘导致，这代表着企业的盈利波动很大，稳定性不足。因此，从 shap 图像上看，处于盈利状态且市盈率不太高的公司质地较好，未来净利润继续攀升的可能性较大。

```{r, out.width='25%', fig.align='center', fig.cap = "流动比率对归母净利润增长率预测影响图"}
knitr::include_graphics("figure/regression/SHAP currentRatio.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "现金比率对归母净利润增长率预测影响图"}
knitr::include_graphics("figure/regression/SHAP cashRatio.png")
```

过高或过低的流动比率都会对未来净利润增长率产生负影响，流动资产超过流动负债时，企业的短期偿债能力能够得到保证，但流动资产过多则显示出企业资金利用率较低，本因用于投资或扩产的资金被闲置。因此，多数情况下，流动资产为流动负债的1-2倍是企业未来成长性最好。现金比率的影响图也与此逻辑相近，适中的现金比率增加了未来成长的预测概率。

```{r, out.width='25%', fig.align='center', fig.cap = "市现率对归母净利润增长率预测影响图"}
knitr::include_graphics("figure/regression/SHAP pcfNcfTTM.png")
```

市现率为企业市值与经营现金净额的比值，经营现金流是企业主营业务赢利性的直接体现，当市现率为正值时，企业经营现金净流入，业务经营情况较好，未来净利润增长具有保障。最差的情况出现在市现率为负值且绝对值较小，此时经营现金流净流出规模较大，业务亏损严重，即使目前净利润可能由其它非经常性收益支撑住，但其主营业务亏损将导致未来净利润下滑可能性较大。

## 对预测过程的解释

我们选取两家较典型具备代表性的公司进行预测结果的分析，进一步深入探讨企业的各项财务指标如何影响成长性的预测。

在选取典型企业时，为尽可能降低阅读者的理解成本，我们选择市场的热点公司贵州茅台最为典型例子。贵州茅台由于过去多年来的高成长性被市场上众多投资者所熟知，同时其财务报表一直被价值投资者视为优质的典范，大部分关注股票市场的读者对其财务状况都有大致了解。同时，为了与成长型企业做区分，我们同时选择包钢股份作为我们分析周期型企业的案例，包钢股份受到钢铁行业重资产、钢铁价格波动剧烈的影响，成长性时高时低，可以用来检验模型预测能力。

因此，我们选择成长股贵州茅台和周期股包钢股份作为我们解释模型预测过程的典型企业。

```{r, out.width='25%', fig.align='center', fig.cap = "贵州茅台2020归母净利润预测解释图"}
knitr::include_graphics("figure/regression/2019shap600519.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "贵州茅台2021归母净利润预测解释图"}
knitr::include_graphics("figure/regression/2020shap600519.png")
```

使用2019年的财务指标预测茅台股份2020年归母净利润增长率，预测给出26%，实际为13%；预测给出2021年归母净利润增长率为19%，实际为12%。模型认为使得未来利润下滑的主要因素是净资产收益率、净利润总营收占比、销售净利率，即对于模型从市场上的所有公司中学习到盈利占比营收或资产比例很大时，很可能已经发展到了成熟阶段，多数情况下未来净利润难以继续保持增长的态势，所以这三项财务指标过高很可能会削弱未来的成长态势。然而模型还是给出了茅台超过基准值12个百分点的预测增长率，原因在于茅台的较高市净率、市销率和主营业务收入规模。相对于其净资产和销售额，较高的估值代表了投资者对茅台未来利润增长的看好。同时，茅台的销售毛利率较高意味着未来只要投入更多的销售资源，销售额的增长很容易反映到利润增长上。

```{r, out.width='25%', fig.align='center', fig.cap = "贵州茅台2020主营业务收入预测解释图"}
knitr::include_graphics("figure/classification/2019shap600519.png")
```

```{r, out.width='25%', fig.align='center', fig.cap = "贵州茅台2021主营业务收入预测解释图"}
knitr::include_graphics("figure/classification/2020shap600519.png")
```

使用2019年的财务指标预测2020年主营业务收入涨跌二分类，预测给出为增长可能性为95.2%，实际主营业务收入也有所增长；使用2020年的财务指标，预测2021年主营业务收入增长可能性为95.8%，模型给出的判断主要依据市净率、权益乘数、当前营收规模。贵州茅台当前营收规模很高，非常高的市净率代表投资者对公司质地的认可，较低的权益乘数代表其财务杠杆率低，现有融资少，未来进一步扩张的潜能大。

```{r, out.width='25%', fig.align='center', fig.cap = "包钢股份2020主营业务收入预测解释图"}
knitr::include_graphics("figure/classification/2019shap600010.png")
```

使用2019年的财务指标预测包钢股份2020年主营业务收入涨跌二分类，预测给出为下滑，实际主营业务收入也有所下滑，模型做出该判断的主要依据为权益乘数、市盈率、经营性现金净流量占比净利润、总资产同比增长率。包钢股份2019年市盈率绝对值非常大，处于盈亏平衡状态，不太符合高成长性公司的一般特征。其利息占比息税前利润过大，说明企业的负债相对于其盈利情况较重，进一步借款改善经营状况的空间很小，负债严重影响企业未来成长。在负债率较高的情况下，资产2019年处于负增长状态，说明企业的资产流失、折旧严重，影响到未来营收的增长。经营性现金净流量为负值，代表企业开展主营业务运营能力较差，在没有新突破的情况下，未来成长能力弱。同时，较大的权益乘数代表股东投入资本占比较小，财务杠杆已经很大，进一步加大杠杆的空间较小，影响未来成长性。

```{r, out.width='25%', fig.align='center', fig.cap = "包钢股份2021主营业务收入预测解释图"}
knitr::include_graphics("figure/classification/2020shap600010.png")
```

模型给出2021年包钢股份主营业务收入不再下滑，开始上涨，与实际情况相符。从2020年财务指标看，相比上一年，2020年盈利情况较好，滚动市盈率不再被模型认为是减分项，同时由于经营情况较好，经营性现金流量占比净利润较高，此项也不再影响未来的成长性。模型认为资产负债率、速动比率、已获利息倍数这几项指标是判定其未来增长的关键指标。较高的资产负债率和较低的速动比率代表了企业的扩张态势，虽然同时会给企业带来较大的利息费用影响净利润增长，但未来营业收入增长可能性较大。正值且较小的已获利息倍数表明了企业的举债规模较大且具备偿还能力，模型学习认为此类企业未来成长性较好。

```{r, out.width='25%', fig.align='center', fig.cap = "递归特征消除效果图"}
# knitr::include_graphics("figure/classification/rfe.png")
```

# 预测未来

由于目前A股所有上市企业 2022 年的年报均尚未披露^[该论文撰写于 2022 年 12 月份，对未来预测的准确率请读者自行验证]，使用 2021 年的财务指标，我们给出 2022 年企业成长性的预测。^[此处仅给出各行业增长率最高和最低的公司，排行前五的企业详见附录]

```{r}
table = read.csv('output/classification/future.csv')
kable(table, caption = '各行业预测2022年主营业务收入增长概率最高与最低公司')
```

```{r}
table = read.csv('output/regression/future.csv')
kable(table, caption = '各行业预测2022年归母净利润增长率最高与最低公司')
```

# 结论及不足

## 研究结论

> 缺少集成学习

本研究以A股全体上市公司为主体，使用年报公开披露的财务指标，对企业未来的成长性展开预测研究。我们使用主营业务收入涨跌和归属母公司净利润增长率衡量企业成长性，使用 T 年的财务指标预测 T+1 年的成长性。

由于企业成长性的影响因素非常多，错综复杂的市场形势和宏观经济都会很大程度影响到企业的经营，准确预测企业未来的收入和利润几乎是一件不可能的事情；因此在预测时我们并不追求预测结果完全准确，而是更多地关注预测未来成长性高的企业与同行业企业的比较，即通过对历史成长性高的企业财务指标共性特征的学习，找到一个未来成长性高的公司组合，这个组合将“跑赢”同行业的其它企业。

1. 使用缺失值填补、高稀疏性分类变量聚类处理、异常值处理、标准化处理、特征变换、SMOTE 过采样处理等预处理和特征工程方法，对喂入模型训练的数据进行处理。经过的交叉验证对三种基本模型进行处理前后效果比较，我们选择最合适的处理方式，很大程度上提高了最终模型的效果。
1. 借助阿里云服务器，使用各种线性、非线性、基于树与规则的模型进行训练、调参和模型校准，经过交叉验证比较，梯度下降树这类模型在企业未来成长性问题上表现较好，效果最好的为 CatBoost 模型，在测试集2020年营业收入涨跌二分类预测上达到了 0.71 的 AUC (召回率 85%，精准度 66%)，相比随机猜测提高 21 个百分点；归母净利润增长率预测上 $R^2$ 达到 0.26。由于营业收入和净利润受到宏观经济、市场需求等众多因素的影响，并不仅仅由企业的财务状况决定，因此该预测模型的效果已经具备很强的现实意义。
1. 使用2020年的财务指标预测2021年的主营业务收入涨跌和归母净利润增长率。各行业模型预测主营业务收入增长的企业实际平均增长率为36%，即使2021年宏观经济形势较好，同行业上市公司平均增长率也仅有23%，除了家用电器行业外，其它27个全部高于同行业其它公司。 各行业预测净利润涨幅前5的企业实际平均增长率为67%，前10的企业为61%，前20的企业为49%，前30的企业为44%，同行业均值仅为18%，预测成长性强的企业实际表现远超同行业企业。
1. 经过模型学习，对企业未来主营业务收入结果影响最大的财务指标排序为权益乘数、资产负债率、市盈率、总资产同比增长率、市净率；对未来归母净利润增长率结果影响最大的指标为净资产收益率、市净率、市盈率、每股收益、经营性现金净流量与净利润之比。我们使用 shap 值分析财务指标对模型的影响方式，同时结合财务指标的实际含义和金融市场的基本面分析，分析财务指标对企业未来成长性的影响逻辑。为了解释模型预测企业未来成长性的逻辑，我们选取贵州茅台和包钢股份两家较典型具备代表性的公司进行预测路径的分析，进一步深入探讨企业的各项财务指标如何影响成长性的预测。
1. 最后，我们给出2022年（目前尚未披露年报）各行业成长性最高和最低的企业预测。

## 不足与改进空间

> 待补充

# 参考文献{-}

\

<div id="refs"></div>

\newpage

# 附录{-}

## 数据概览

```{r}
dictionary %>% 
  select(指标名称, 指标计算方式) %>% 
  kable(caption = '指标的计算方式')
```

```{r}
# table = str(dat)
# kable(table)

# table = as.data.frame(summary(dat))
# table = t(table)
# kable(table)
```

```{r}
names(industry_table) = c('行业', '股票数量', '占比')
kable(industry_table, caption = "申万行业个股数量及占比")
```

## 训练迭代过程

[待补充]

## 对未来的预测明细

[待补充]
